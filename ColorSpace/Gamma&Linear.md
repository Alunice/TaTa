# 色彩空间

因人眼对暗部的敏感度更高，以及早期显示设备存储空间有限的原因，显示设备都会默认进行一次Gamma2.2的操作，0-1的值通过pow(c,2.2)计算，更多的值（0.73以下）被压缩在了0.5以下，即使用了更多的比特位存储暗部的值，尽可能多的保留暗部细节。

而人眼看到的物理世界是线性空间下的，所以，为了使经过显示器2.2压暗的图像还原回线性空间，需要进行一次pow(c,0.45)操作，即gamma矫正，而gamma0.45也就是微软、惠普开发的sRGB色彩空间。

![色彩空间](https://pic1.zhimg.com/v2-a2bb5a3d0b7c0269f95fb51f5f73ef90_r.jpg)

左(Gamma0.45) 中(Gamma2.2) 右(线性物理空间)

## unity 色彩空间
unity有gamma和linear两个色彩空间，如果选择的是gamma空间，unity不会对shader输入、输出做任何处理，因为默认shader色彩计算是在sRGB（gamma0.45），通过显示器的2.2计算就是正确结果，所以原始贴图是什么样，输出就是什么样。而我们之所以看到贴图显示的色彩是正常的，是因为当我们用PS制作贴图时，贴图存储的颜色本身就是在sRGB空间中了（也就是说存储的值比我们在显示器上看见的颜色值要更高一些），再经过显示器的Gamma2.2操作，我们看见的就是正常线性空间中的色彩值。如果在gamma色彩空间使用linear贴图，显示结果会偏暗。

linear空间会默认shader中的色彩计算是在线性空间中的，所以计算结果会经过一次pow(c,0.45)，也就是gamma矫正，这样再经过显示器的2.2操作，就又回到线性空间，即正确的显示结果。这时我们在贴图的inspector面板可以选择贴图是否为sRGB，如果勾选，unity在shader采样时会进行一次pow(c,2.2)计算，将贴图从sRGB转换到线性空间。不勾选则不做任何处理。

## lut在linear中处理的解释
我们有两种操作可以让结果看上去正确：

1、勾选sRGB,lutshader对输入color做pow(c,0.45)。

2、不勾选sRGB,lutshader对输入color做pow(c,0.45)，对输出做pow(c,2.2)。

通过前面内容，我们来解释这两种操作：

首先要明确一点，lut贴图是在ps中制作的，也就是说，lut的查找是在gamma空间中完成的（贴图存储的值比ps中通过显示器看到的值更高）。那么，为了实现正确的lut查找，输入color一定要转换到sRGB空间（gamma0.45）才能得到正确的查找坐标。所以两种操作首先都要进行pow(c,0.45)。

找到了正确的坐标，从lut中取出的值同样也是sRGB空间中的，若此时我们不进行任何操作，linear空间下，unity会对所有的输出都做一次pow(c,0.45)，对于sRGB空间的值，相当于映射到了一个更亮的空间，哪怕经过显示器的2.2操作，也只是回到了sRGB，所以显示结果会更亮。

所以，为了得到正确的结果，我们要么勾选贴图的sRGB，因为这样在shader采样时会自动进行一次pow(c,2.2)将sRGB空间下的值转换成线性空间下的值。或者不勾选sRGB，我们手动的在shader中进行sRGB到linear的转换，同样也能得到正确的结果。

这两种操作在显示上有细微差别，应该是shader中精度带来的误差，一个是手动改shader计算，一个是管线可能有更高精度或硬件方面的支持。

